"use client";

import { useState } from "react";
import { PortfolioChart } from "./PortfolioChart";

interface PortfolioSummaryProps {
    assets: {
        symbol: string;
        totalValueEUR: number;
        type: string;
        exchange?: string;
        sector?: string;
        currency?: string;
        country?: string;
        platform?: string;
    }[];
    totalValueEUR: number;
    isMock?: boolean;
    isBlurred?: boolean;
}

const TABS = ["1D", "1W", "1M", "YTD", "1Y", "ALL"];
const CURRENCIES = ["EUR", "USD", "TRY"] as const;
const ALLOCATION_VIEWS = ["Type", "Positions", "Exchange", "Currency", "Country", "Sector", "Platform"];
const COLORS = ['#6366f1', '#ec4899', '#10b981', '#f59e0b', '#8b5cf6', '#ef4444', '#06b6d4', '#14b8a6', '#f97316'];

// Country mapping from exchange
const getCountryFromExchange = (exchange?: string): string => {
    if (!exchange) return 'Unknown';
    const ex = exchange.toUpperCase();
    if (ex.includes('BIST') || ex.includes('IST')) return 'Turkey';
    if (ex.includes('NASDAQ') || ex.includes('NYSE')) return 'USA';
    if (ex.includes('LON') || ex.includes('LSE')) return 'UK';
    if (ex.includes('FRA')) return 'Germany';
    if (ex.includes('PAR')) return 'France';
    return 'Other';
};

export function PortfolioSummary({ assets, totalValueEUR, isMock = false, isBlurred = false }: PortfolioSummaryProps) {
    const [activeTab, setActiveTab] = useState("1D");
    const [currency, setCurrency] = useState<typeof CURRENCIES[number]>("EUR");
    const [hoveredSlice, setHoveredSlice] = useState<string | null>(null);
    const [allocationView, setAllocationView] = useState("Type");
    const [chartView, setChartView] = useState<"pie" | "bar">("pie");

    // Static conversion rates for UI smoothness
    const rates = { EUR: 1, USD: 1.05, TRY: 38.5 };
    const currencySymbols = { EUR: "â‚¬", USD: "$", TRY: "â‚º" };

    const convert = (amount: number) => amount * rates[currency];

    // Derived Stats
    const totalReturnAmtEUR = isMock ? 1245.50 : (totalValueEUR * 0.12);
    const totalReturnPct = isMock ? 15.4 : 12.0;

    // Period stats
    const factor = activeTab === "1D" ? 0.05 : activeTab === "1W" ? 0.3 : 1;
    const periodReturnAmtEUR = totalReturnAmtEUR * factor;
    const periodReturnPct = totalReturnPct * factor;

    // Display Values
    const displayBalance = convert(totalValueEUR);
    const displayPeriodReturn = convert(periodReturnAmtEUR);
    const displayTotalReturn = convert(totalReturnAmtEUR);
    const sym = currencySymbols[currency];

    // Dynamic data based on allocation view
    const getChartData = () => {
        switch (allocationView) {
            case "Type":
                return assets.reduce((acc, asset) => {
                    const existing = acc.find(item => item.name === asset.type);
                    if (existing) {
                        existing.value += asset.totalValueEUR;
                    } else {
                        acc.push({ name: asset.type, value: asset.totalValueEUR });
                    }
                    return acc;
                }, [] as { name: string; value: number }[]);

            case "Positions":
                return assets.map(asset => ({
                    name: asset.symbol,
                    value: asset.totalValueEUR
                }));

            case "Exchanges":
                return assets.reduce((acc, asset) => {
                    const exchange = asset.exchange || 'Unknown';
                    const existing = acc.find(item => item.name === exchange);
                    if (existing) {
                        existing.value += asset.totalValueEUR;
                    } else {
                        acc.push({ name: exchange, value: asset.totalValueEUR });
                    }
                    return acc;
                }, [] as { name: string; value: number }[]);

            case "Sectors":
                return assets.reduce((acc, asset) => {
                    const sector = asset.sector || 'Unknown';
                    const existing = acc.find(item => item.name === sector);
                    if (existing) {
                        existing.value += asset.totalValueEUR;
                    } else {
                        acc.push({ name: sector, value: asset.totalValueEUR });
                    }
                    return acc;
                }, [] as { name: string; value: number }[]);

            case "Currencies":
                return assets.reduce((acc, asset) => {
                    const curr = asset.currency || 'Unknown';
                    const existing = acc.find(item => item.name === curr);
                    if (existing) {
                        existing.value += asset.totalValueEUR;
                    } else {
                        acc.push({ name: curr, value: asset.totalValueEUR });
                    }
                    return acc;
                }, [] as { name: string; value: number }[]);

            default:
                return [];
        }
    };

    const chartData = getChartData();
    const sortedData = [...chartData].sort((a, b) => b.value - a.value);
    const totalVal = sortedData.reduce((sum, item) => sum + item.value, 0);

    return (
        <div style={{ position: 'relative' }}>

            {/* Global Privacy Toggle (Top Center) */}

            <div style={{
                display: 'grid',
                gridTemplateColumns: '1fr 1fr',
                gap: '1.5rem',
                alignItems: 'stretch'
            }}>
                {/* LEFT CARD: Stats */}
                <div className="glass-panel" style={{
                    borderRadius: '1rem',
                    padding: '1.5rem 1.5rem',
                    display: 'flex',
                    flexDirection: 'column',
                    gap: '1.5rem',
                    position: 'relative',
                    textAlign: 'center'
                }}>
                    {/* Balance */}
                    <div>
                        <div style={{ fontSize: '1rem', opacity: 0.6, marginBottom: '0.75rem' }}>Total Balance</div>
                        <div style={{
                            fontSize: '2.5rem',
                            fontWeight: 800,
                            filter: isBlurred ? 'blur(8px)' : 'none',
                            transition: 'filter 0.3s ease'
                        }}>
                            {sym}{displayBalance.toLocaleString('en-US', { minimumFractionDigits: 2, maximumFractionDigits: 2 })}
                        </div>
                    </div>

                    {/* Time Period Tabs */}
                    <div style={{ display: 'flex', gap: '0.5rem', justifyContent: 'center', flexWrap: 'wrap' }}>
                        {TABS.map(tab => (
                            <button
                                key={tab}
                                onClick={() => setActiveTab(tab)}
                                style={{
                                    background: activeTab === tab ? 'rgba(99, 102, 241, 0.2)' : 'rgba(255,255,255,0.05)',
                                    border: activeTab === tab ? '1px solid #6366f1' : '1px solid rgba(255,255,255,0.1)',
                                    borderRadius: '0.4rem',
                                    color: activeTab === tab ? '#6366f1' : 'rgba(255,255,255,0.5)',
                                    padding: '0.4rem 0.75rem',
                                    fontSize: '0.75rem',
                                    fontWeight: 600,
                                    cursor: 'pointer',
                                    transition: 'all 0.2s'
                                }}
                            >
                                {tab}
                            </button>
                        ))}
                    </div>

                    {/* Currency Selector */}
                    <div style={{ display: 'flex', gap: '0.5rem', justifyContent: 'center' }}>
                        {CURRENCIES.map(c => (
                            <button
                                key={c}
                                onClick={() => setCurrency(c)}
                                style={{
                                    background: currency === c ? 'rgba(255,193,7,0.2)' : 'transparent',
                                    border: 'none',
                                    color: currency === c ? '#ffc107' : 'rgba(255,255,255,0.5)',
                                    padding: '0.35rem 0.75rem',
                                    borderRadius: '0.4rem',
                                    fontSize: '0.8rem',
                                    fontWeight: 600,
                                    cursor: 'pointer',
                                    transition: 'all 0.2s'
                                }}
                            >
                                {c}
                            </button>
                        ))}
                    </div>

                    {/* Returns */}
                    <div style={{
                        display: 'grid',
                        gridTemplateColumns: '1fr 1fr',
                        gap: '1rem',
                        filter: isBlurred ? 'blur(8px)' : 'none',
                        transition: 'filter 0.3s ease'
                    }}>
                        <div>
                            <div style={{ fontSize: '0.8rem', opacity: 0.5, marginBottom: '0.25rem' }}>{activeTab} Return</div>
                            <div style={{ fontSize: '1.25rem', fontWeight: 700, color: '#10b981' }}>
                                â–² {periodReturnPct.toFixed(2)}%
                            </div>
                            <div style={{ fontSize: '0.85rem', color: '#10b981', marginTop: '0.15rem' }}>
                                +{sym}{displayPeriodReturn.toFixed(2)}
                            </div>
                        </div>
                        <div>
                            <div style={{ fontSize: '0.8rem', opacity: 0.5, marginBottom: '0.25rem' }}>Total Return</div>
                            <div style={{ fontSize: '1.25rem', fontWeight: 700, color: '#10b981' }}>
                                â–² {totalReturnPct.toFixed(2)}%
                            </div>
                            <div style={{ fontSize: '0.85rem', color: '#10b981', marginTop: '0.15rem' }}>
                                +{sym}{displayTotalReturn.toFixed(2)}
                            </div>
                        </div>
                    </div>
                </div>

                {/* RIGHT CARD: Chart & List */}
                <div className="glass-panel" style={{
                    borderRadius: '1rem',
                    padding: '1.5rem',
                    position: 'relative',
                    textAlign: 'center'
                >}}>
                    {/* Header with Chart View Toggle */}
                    <div style={{ display: 'flex', justifyContent: 'space-between', alignItems: 'center', marginBottom: '1rem' }}>
                        <div style={{ fontSize: '1.25rem', opacity: 0.6 }}>Portfolio Allocation</div>
                        
                        {/* Chart View Toggle */}
                        <div style={{ display: 'flex', gap: '0.25rem', background: 'rgba(255,255,255,0.05)', borderRadius: '0.5rem', padding: '0.2rem' }}>
                            <button
                                onClick={() => setChartView("pie")}
                                title="Pie Chart"
                                style={{
                                    background: chartView === "pie" ? 'rgba(99, 102, 241, 0.2)' : 'transparent',
                                    border: 'none',
                                    borderRadius: '0.35rem',
                                    color: chartView === "pie" ? '#6366f1' : 'rgba(255,255,255,0.5)',
                                    padding: '0.35rem 0.5rem',
                                    fontSize: '1.1rem',
                                    cursor: 'pointer',
                                    transition: 'all 0.2s',
                                    lineHeight: 1
                                }}
                            >
                                â­•
                            </button>
                            <button
                                onClick={() => setChartView("bar")}
                                title="Bar Chart"
                                style={{
                                    background: chartView === "bar" ? 'rgba(99, 102, 241, 0.2)' : 'transparent',
                                    border: 'none',
                                    borderRadius: '0.35rem',
                                    color: chartView === "bar" ? '#6366f1' : 'rgba(255,255,255,0.5)',
                                    padding: '0.35rem 0.5rem',
                                    fontSize: '1.1rem',
                                    cursor: 'pointer',
                                    transition: 'all 0.2s',
                                    lineHeight: 1
                                }}
                            >
                                ðŸ“Š
                            </button>
                        </div>
                    </div>

                    {/* Allocation View Tabs */}
                    <div style={{ display: 'flex', gap: '0.5rem', marginBottom: '1.5rem', justifyContent: 'center', flexWrap: 'wrap' }}>
                        {ALLOCATION_VIEWS.map(view => (
                            <button
                                key={view}
                                onClick={() => setAllocationView(view)}
                                style={{
                                    background: allocationView === view ? 'rgba(99, 102, 241, 0.2)' : 'transparent',
                                    border: allocationView === view ? '1px solid #6366f1' : 'none',
                                    borderBottom: allocationView === view ? '2px solid #6366f1' : '2px solid transparent',
                                    color: allocationView === view ? '#6366f1' : 'rgba(255,255,255,0.5)',
                                    padding: '0.4rem 0.75rem',
                                    fontSize: '0.75rem',
                                    fontWeight: allocationView === view ? 700 : 500,
                                    cursor: 'pointer',
                                    transition: 'all 0.2s',
                                    borderRadius: '0.25rem 0.25rem 0 0'
                                }}
                            >
                                {view}
                            </button>
                        ))}
                    </div>

                    <div style={{
                        filter: isBlurred ? 'blur(8px)' : 'none',
                        transition: 'filter 0.3s ease',
                        display: 'flex',
                        alignItems: 'center',
                        height: '280px'
                    }}>
                        <div style={{ flex: '1', height: '100%' }}>
                            <PortfolioChart
                                assets={chartData}
                                totalValueEUR={totalValueEUR}
                                showLegend={false}
                                onHover={setHoveredSlice}
                                activeSliceName={hoveredSlice}
                            />
                        </div>

                        {/* Sorted List Area */}
                        <div style={{ flex: '0.8', display: 'flex', flexDirection: 'column', gap: '0.5rem', paddingLeft: '0.5rem', maxHeight: '280px', overflowY: 'auto' }}>
                            {sortedData.map((item, index) => {
                                const pct = (item.value / totalVal) * 100;
                                const color = COLORS[index % COLORS.length];
                                const isHovered = hoveredSlice === item.name;

                                return (
                                    <div
                                        key={item.name}
                                        onMouseEnter={() => setHoveredSlice(item.name)}
                                        onMouseLeave={() => setHoveredSlice(null)}
                                        style={{
                                            display: 'flex',
                                            alignItems: 'center',
                                            justifyContent: 'space-between',
                                            fontSize: '0.9rem',
                                            padding: '0.5rem',
                                            borderRadius: '0.5rem',
                                            background: isHovered ? 'rgba(255,255,255,0.1)' : 'transparent',
                                            cursor: 'pointer',
                                            transition: 'all 0.2s',
                                            opacity: (hoveredSlice && !isHovered) ? 0.3 : 1,
                                            transform: isHovered ? 'scale(1.02)' : 'scale(1)'
                                        }}
                                    >
                                        <div style={{ display: 'flex', alignItems: 'center', gap: '0.5rem', flex: 1 }}>
                                            <div style={{ width: '0.75rem', height: '0.75rem', borderRadius: '50%', background: color, flexShrink: 0 }}></div>
                                            <span style={{ fontSize: '0.8rem', fontWeight: 600, whiteSpace: 'nowrap', overflow: 'hidden', textOverflow: 'ellipsis' }}>{item.name}</span>
                                        </div>
                                        <span style={{ fontSize: '0.8rem', fontWeight: 700, color, marginLeft: '0.5rem' }}>{pct.toFixed(1)}%</span>
                                    </div>
                                );
                            })}
                        </div>
                    </div>
                </div>
            </div>
        </div>
    );
}
